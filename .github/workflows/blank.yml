name: "Artifactory Generic OIDC Multi-Job"

on:
  workflow_dispatch:
  push:

env:
  OIDC_PROVIDER: 'manu-new'
  OIDC_AUDIENCE: 'newmanu'
  JF_URL: "https://hts2.jfrog.io"

permissions:
  contents: read
  id-token: write

jobs:
  publish-artifact:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      # Step 1: Set up JFrog CLI with OIDC
      - name: Set up JFrog CLI with OIDC
        id: jfrog_setup
        uses: jfrog/setup-jfrog-cli@v4
        env:
          JF_URL: ${{ env.JF_URL }}
        with:
          oidc-provider-name: ${{ env.OIDC_PROVIDER }}
          oidc-audience: ${{ env.OIDC_AUDIENCE }}

      # Step 2: Archive Terraform Module
      - name: Archive Terraform Module
        run: |
          MODULE_VERSION=${{ github.ref_name }}
          MODULE_NAME='vpc'
          MODULE_NAMESPACE='myorg'
          ZIP_FILE="${MODULE_NAME}-aws-${MODULE_VERSION}.zip"
          zip -r $ZIP_FILE . -x '*.git*'
          echo "ZIPPING complete. File: $ZIP_FILE"
          echo "MODULE_NAMESPACE=$MODULE_NAMESPACE" >> $GITHUB_ENV
          echo "MODULE_NAME=$MODULE_NAME" >> $GITHUB_ENV
          echo "MODULE_VERSION=$MODULE_VERSION" >> $GITHUB_ENV
          echo "ZIP_FILE=$ZIP_FILE" >> $GITHUB_ENV
          ls -la $ZIP_FILE
      # Step 3: Publish Terraform Module to Artifactory
      - name: Publish Terraform Module to Artifactory
        run: |
          jf rt u ${{ env.ZIP_FILE }} manu-terra-module/${{ env.MODULE_NAMESPACE }}/${{ env.MODULE_NAME }}/aws/${{ env.MODULE_VERSION }}/
      # Step 4: Publish Build Info
      - name: Publish Build Info
        run: |
          jf rt build-collect-env
          jf rt build-add-git
          jf rt build-publish
      # Step 5: Create a basic main.tf for testing module resolution
      - name: Create main.tf for testing
        run: |
          echo "Module URL: ${{ env.JF_URL }}/manu-terra-module__${{ env.MODULE_NAMESPACE }}/${{ env.MODULE_NAME }}/aws"
          cat <<EOF > main.tf
          module "module-name" {
            source  = "hts2.jfrog.io/manu-terra-module__${{ env.MODULE_NAMESPACE }}/${{ env.MODULE_NAME }}/aws"
          }
          EOF
          echo "Created main.tf:"
          cat main.tf
            # Step 6: Setup Terraform
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.9.8

      # Step 7: Retrieve JFrog Access Token and Configure Terraform Authentication
      - name: Configure Terraform Authentication
        run: |
          echo "ðŸ” Exporting and decoding JFrog CLI config..."
          
          # Export and decode the Base64 JFrog configuration
          jf c export > jfconfig.b64
          base64 -d jfconfig.b64 > jfconfig.json
          echo "ðŸ”¹ Decoded JFrog config:"
          cat jfconfig.json | head -20  # show first few lines for debug
          # Extract the access token (handles both 'access_token' and 'accessToken')
          TOKEN=$(cat jfconfig.json | grep -E '"access_token"|"accessToken"' | head -1 | awk -F'"' '{print $4}')
          if [ -z "$TOKEN" ]; then
            echo "âŒ Failed to extract JFrog access token from decoded CLI config."
            exit 1
          fi
          echo "âœ… Token extracted successfully."
          echo "TF_TOKEN_HTS2_JFROG_IO=$TOKEN" >> $GITHUB_ENV
          echo "âœ… Terraform authentication configured for hts2.jfrog.io"
           # 1. Create the .terraform.d directory if it doesn't exist (Terraform standard location)
                    mkdir -p ~/.terraform.d
          
                     # 2. Define the path to the credentials file
                     CREDENTIALS_FILE="$HOME/.terraform.d/credentials.tfrc.json"
          
                     # 3. Create the JSON content, injecting the ACCESS_TOKEN
                     #    The 'hts2.jfrog.io' must exactly match the host in your module source.
                    cat << EOF > ${CREDENTIALS_FILE}
                        {
                          "credentials": {
                             "hts2.jfrog.io": {
                              "token": "$TOKEN"
                                                }
                                               }
                                           }
                     EOF
          
     
                     cat $HOME/.terraform.d/credentials.tfrc.json
                     echo "Successfully configured Artifactory token in ${CREDENTIALS_FILE}"
      # Step 8: Initialize and Validate Terraform
      - name: Terraform Init & Validate
        run: |
          terraform init -upgrade
          terraform validate
